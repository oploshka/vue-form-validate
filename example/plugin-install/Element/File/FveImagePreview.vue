<template>
  <label
    v-bind:class="[
      'file-image-preview fip',
      { 'has-error': error.code === 'ERROR' },
    ]"
  >
    <template v-if="value.file && value.file.getSrc()">
      <div class="icon fip__img">
        <img :src="value.file.getSrc()" alt="" />
      </div>
    </template>
    <svg
      width="44"
      height="44"
      viewBox="0 0 44 44"
      xmlns="http://www.w3.org/2000/svg"
    >
      <g opacity="0.25">
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M31.9733 11.4334C32.0467 11.5616 32.175 11.6532 32.34 11.6532C36.74 11.6532 40.3333 15.2425 40.3333 19.6376V30.5155C40.3333 34.9107 36.74 38.5 32.34 38.5H11.66C7.24166 38.5 3.66666 34.9107 3.66666 30.5155V19.6376C3.66666 15.2425 7.24166 11.6532 11.66 11.6532C11.8067 11.6532 11.9533 11.5799 12.0083 11.4334L12.1183 11.2137C12.1815 11.0806 12.2464 10.944 12.3122 10.8053C12.7813 9.81741 13.3001 8.72447 13.6217 8.08213C14.465 6.43396 15.895 5.51831 17.6733 5.5H26.3083C28.0867 5.51831 29.535 6.43396 30.3783 8.08213C30.6671 8.65898 31.107 9.58816 31.531 10.4837C31.6185 10.6686 31.7053 10.852 31.79 11.0305L31.9733 11.4334ZM30.635 18.4656C30.635 19.3812 31.3683 20.1138 32.285 20.1138C33.2017 20.1138 33.9533 19.3812 33.9533 18.4656C33.9533 17.5499 33.2017 16.7991 32.285 16.7991C31.3683 16.7991 30.635 17.5499 30.635 18.4656ZM18.8283 21.3041C19.69 20.4434 20.8083 19.9856 22 19.9856C23.1917 19.9856 24.31 20.4434 25.1533 21.2858C25.9967 22.1282 26.455 23.2453 26.455 24.4356C26.4367 26.8896 24.4567 28.8857 22 28.8857C20.8083 28.8857 19.69 28.4279 18.8467 27.5855C18.0033 26.7431 17.545 25.626 17.545 24.4356V24.4173C17.5267 23.2636 17.985 22.1465 18.8283 21.3041ZM27.0783 29.5266C25.7767 30.8269 23.98 31.6326 22 31.6326C20.075 31.6326 18.2783 30.8818 16.9033 29.5266C15.5467 28.1532 14.795 26.3585 14.795 24.4356C14.7767 22.5311 15.5283 20.7364 16.885 19.3629C18.26 17.9895 20.075 17.2386 22 17.2386C23.925 17.2386 25.74 17.9895 27.0967 19.3446C28.4533 20.7181 29.205 22.5311 29.205 24.4356C29.1867 26.4317 28.38 28.2264 27.0783 29.5266Z"
          fill="#E0E0EC"
        />
        <path
          d="M31.9733 11.4334L31.5182 11.6405L31.5278 11.6616L31.5393 11.6817L31.9733 11.4334ZM12.0083 11.4334L11.5612 11.2096L11.5495 11.2331L11.5402 11.2577L12.0083 11.4334ZM12.1183 11.2137L12.5655 11.4375L12.57 11.4282L12.1183 11.2137ZM12.3122 10.8053L12.7639 11.0198V11.0198L12.3122 10.8053ZM13.6217 8.08213L13.1765 7.85437L13.1746 7.85833L13.6217 8.08213ZM17.6733 5.5V4.99997L17.6682 5.00003L17.6733 5.5ZM26.3083 5.5L26.3135 5H26.3083V5.5ZM30.3783 8.08213L30.8255 7.85832L30.8234 7.85438L30.3783 8.08213ZM31.531 10.4837L31.0791 10.6977L31.0791 10.6977L31.531 10.4837ZM31.79 11.0305L32.2452 10.8234L32.2418 10.8163L31.79 11.0305ZM18.8283 21.3041L18.475 20.9504L18.8283 21.3041ZM25.1533 21.2858L24.8 21.6395L25.1533 21.2858ZM26.455 24.4356L26.955 24.4394V24.4356H26.455ZM17.545 24.4173H18.0451L18.0449 24.4094L17.545 24.4173ZM16.9033 29.5266L16.5476 29.878L16.5524 29.8828L16.9033 29.5266ZM14.795 24.4356H15.295L15.295 24.4308L14.795 24.4356ZM16.885 19.3629L16.5316 19.0092L16.5293 19.0116L16.885 19.3629ZM27.0967 19.3446L27.4524 18.9932L27.45 18.9909L27.0967 19.3446ZM29.205 24.4356L29.705 24.4402V24.4356H29.205ZM32.34 11.1532C32.3454 11.1532 32.3535 11.154 32.3631 11.1568C32.3726 11.1595 32.3812 11.1636 32.3885 11.1681C32.3956 11.1726 32.4004 11.1769 32.4033 11.18C32.4062 11.1831 32.4073 11.185 32.4073 11.1851L31.5393 11.6817C31.6876 11.9408 31.9689 12.1532 32.34 12.1532V11.1532ZM40.8333 19.6376C40.8333 14.9658 37.0156 11.1532 32.34 11.1532V12.1532C36.4644 12.1532 39.8333 15.5192 39.8333 19.6376H40.8333ZM40.8333 30.5155V19.6376H39.8333V30.5155H40.8333ZM32.34 39C37.0156 39 40.8333 35.1873 40.8333 30.5155H39.8333C39.8333 34.634 36.4644 38 32.34 38V39ZM11.66 39H32.34V38H11.66V39ZM3.16666 30.5155C3.16666 35.1866 6.9653 39 11.66 39V38C7.51803 38 4.16666 34.6347 4.16666 30.5155H3.16666ZM3.16666 19.6376V30.5155H4.16666V19.6376H3.16666ZM11.66 11.1532C6.9653 11.1532 3.16666 14.9666 3.16666 19.6376H4.16666C4.16666 15.5184 7.51803 12.1532 11.66 12.1532V11.1532ZM11.5402 11.2577C11.5566 11.2141 11.5874 11.1836 11.6138 11.168C11.6366 11.1545 11.6529 11.1532 11.66 11.1532V12.1532C11.9542 12.1532 12.3289 12.0021 12.4764 11.6091L11.5402 11.2577ZM11.6712 10.9898L11.5612 11.2096L12.4554 11.6572L12.5654 11.4375L11.6712 10.9898ZM11.8606 10.5909C11.7947 10.7296 11.7299 10.8661 11.6667 10.9991L12.57 11.4282C12.6332 11.2951 12.6981 11.1584 12.7639 11.0198L11.8606 10.5909ZM13.1746 7.85833C12.8501 8.50652 12.3284 9.60535 11.8606 10.5909L12.7639 11.0198C13.2341 10.0295 13.7502 8.94242 14.0688 8.30594L13.1746 7.85833ZM17.6682 5.00003C15.6933 5.02036 14.0996 6.05048 13.1765 7.85438L14.0668 8.30989C14.8304 6.81744 16.0967 6.01626 17.6785 5.99997L17.6682 5.00003ZM26.3083 5H17.6733V6H26.3083V5ZM30.8234 7.85438C29.8993 6.04835 28.2861 5.02034 26.3135 5.00003L26.3032 5.99997C27.8873 6.01629 29.1707 6.81958 29.9332 8.30989L30.8234 7.85438ZM31.9829 10.2698C31.56 9.3766 31.1173 8.44131 30.8254 7.85833L29.9312 8.30594C30.2169 8.87665 30.6539 9.79972 31.0791 10.6977L31.9829 10.2698ZM32.2418 10.8163C32.1572 10.6379 32.0704 10.4546 31.9829 10.2698L31.0791 10.6977C31.1666 10.8825 31.2535 11.066 31.3382 11.2448L32.2418 10.8163ZM32.4284 11.2263L32.2451 10.8234L31.3349 11.2376L31.5182 11.6405L32.4284 11.2263ZM32.285 19.6138C31.6439 19.6138 31.135 19.1046 31.135 18.4656H30.135C30.135 19.6579 31.0927 20.6138 32.285 20.6138V19.6138ZM33.4533 18.4656C33.4533 19.0974 32.9333 19.6138 32.285 19.6138V20.6138C33.4701 20.6138 34.4533 19.6651 34.4533 18.4656H33.4533ZM32.285 17.2991C32.926 17.2991 33.4533 17.8266 33.4533 18.4656H34.4533C34.4533 17.2733 33.4773 16.2991 32.285 16.2991V17.2991ZM31.135 18.4656C31.135 17.8194 31.6511 17.2991 32.285 17.2991V16.2991C31.0855 16.2991 30.135 17.2805 30.135 18.4656H31.135ZM22 19.4856C20.6757 19.4856 19.4303 19.9961 18.475 20.9504L19.1817 21.6579C19.9497 20.8907 20.941 20.4856 22 20.4856V19.4856ZM25.5067 20.932C24.5686 19.995 23.3227 19.4856 22 19.4856V20.4856C23.0606 20.4856 24.0514 20.8918 24.8 21.6395L25.5067 20.932ZM26.955 24.4356C26.955 23.1139 26.4448 21.8691 25.5067 20.932L24.8 21.6395C25.5485 22.3873 25.955 23.3767 25.955 24.4356H26.955ZM22 29.3857C24.7357 29.3857 26.9346 27.1636 26.955 24.4394L25.955 24.4319C25.9387 26.6155 24.1777 28.3857 22 28.3857V29.3857ZM18.4933 27.9392C19.4314 28.8763 20.6773 29.3857 22 29.3857V28.3857C20.9394 28.3857 19.9486 27.9794 19.2 27.2317L18.4933 27.9392ZM17.045 24.4356C17.045 25.7574 17.5552 27.0021 18.4933 27.9392L19.2 27.2317C18.4515 26.484 18.045 25.4945 18.045 24.4356H17.045ZM17.045 24.4173V24.4356H18.045V24.4173H17.045ZM18.475 20.9504C17.5387 21.8856 17.0245 23.1321 17.0451 24.4253L18.0449 24.4094C18.0288 23.3951 18.4313 22.4074 19.1817 21.6579L18.475 20.9504ZM22 32.1326C24.1184 32.1326 26.0405 31.27 27.4317 29.8804L26.725 29.1729C25.5128 30.3837 23.8416 31.1326 22 31.1326V32.1326ZM16.5524 29.8828C18.0189 31.3282 19.9409 32.1326 22 32.1326V31.1326C20.2091 31.1326 18.5377 30.4354 17.2543 29.1705L16.5524 29.8828ZM14.295 24.4356C14.295 26.4929 15.1006 28.413 16.5476 29.878L17.2591 29.1753C15.9928 27.8933 15.295 26.224 15.295 24.4356H14.295ZM16.5293 19.0116C15.0829 20.4759 14.2754 22.3973 14.295 24.4404L15.295 24.4308C15.278 22.6649 15.9738 20.9969 17.2407 19.7143L16.5293 19.0116ZM22 16.7386C19.9419 16.7386 18 17.5425 16.5316 19.0092L17.2384 19.7167C18.52 18.4364 20.2081 17.7386 22 17.7386V16.7386ZM27.45 18.9909C25.9994 17.5418 24.0572 16.7386 22 16.7386V17.7386C23.7928 17.7386 25.4806 18.4371 26.7433 19.6984L27.45 18.9909ZM29.705 24.4356C29.705 22.3973 28.8999 20.4587 27.4524 18.9932L26.7409 19.696C28.0067 20.9775 28.705 22.6649 28.705 24.4356H29.705ZM27.4317 29.8804C28.8235 28.4901 29.6854 26.5711 29.705 24.4402L28.705 24.431C28.6879 26.2924 27.9365 27.9627 26.725 29.1729L27.4317 29.8804Z"
          fill="#191924"
        />
      </g>
    </svg>
    <input
      class="fip__input"
      type="file"
      :id="'file-' + field.name"
      ref="file"
      accept="image/*"
      @change="handleFileUpload()"
      
    />
  </label>
</template>

<script>
import FveMixinField from "vue-form-element/src/Mixin/FveMixinField";

export default {
  mixins: [FveMixinField],
  props: {
    modelValue: {
      type: FileClass,
      default: () => {
        return new FileClass({});
      },
    },
  },
  methods: {
    handleFileUpload() {
      const file = this.$refs.file.files[0];

      let reader = new FileReader();
      reader.addEventListener(
        "load",
        () => {
  
          let fileUpdate = new FileClass({
            src: reader.result,
            file: file,
          });
          this.fieldValueUpdate({file: fileUpdate});
          
        },
        false
      );

      if (file) {
        if (/\.(jpe?g|png|gif)$/i.test(file.name)) {
          reader.readAsDataURL(file);
        }
      }
    },
    rm(event) {
      let file = new FileClass({
        src: "",
        file: {},
      });
      this.fieldValueUpdate({file: file});
    },

    
    // описываем структуру value
    valueSchema() {
      return {
        file: {type: String, default: () => { return null; } }
      };
    },
    convertObjectToValue(valueObj) {
      return valueObj.file;
    },
    convertValueToObject(value) {
      return {
        file: value,
      };
    },
    isEmpty(valueObj) {
      return !valueObj.file || !valueObj.file.getSrc();
    },
    validate(valueObj) {
      return null;
    },
    // Установить фокус на текущий элемент
    setFocus(){
      this.$refs.file.focus();
    },
  },
};
</script>

<style lang="scss" scoped>
.fip {
  position: relative;
  display: block;
  width: 100%;
  height: 100%;
  padding: 0;
  background-color: #f8f8fa;
  border-radius: 0;
  transition: all 0.2s ease-in-out;
  overflow: hidden;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;

  svg {
    width: 60%;
    height: 60%;
  }
  &:hover {
    .fip__img ~ svg {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
      path:first-child {
        fill: #BABACE;
      }
    }
  }
  &__img {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    img {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }
  }
  &__input {
    width: 100%;
    opacity: 0;
    position: absolute;
    z-index: -1;
  }
  &__icon {
    position: absolute;
    left: 50%;
    top: 50%;
    display: block;
    width: 68px;
    height: auto;
    transform: translate(-50%, -50%);
    opacity: 0.5;
    z-index: 1;
  }
  &.has-error {
    border: 1px solid #c82333;
  }
}
</style>
